name: LunchChat CI/CD Pipeline

on:
  push:
    branches:
      - main
      - 'dev/**'
  pull_request:
    branches:
      - main
      - 'dev/**'

env:
  DOCKER_IMAGE_NAME: lunchchat-backend
  DOCKER_REGISTRY: xoo1228
  DEPLOY_SCRIPT: |
    set -e
    
    # ê³µí†µ í•¨ìˆ˜ë“¤
    ensure_image() {
      local img="$1"
      if ! docker image inspect "$img" >/dev/null 2>&1; then
        docker pull "$img" || return 1
      fi
    }
    
    start_services() {
      local tag="$1"
      export IMAGE_TAG="$tag"
      docker-compose up -d backend --no-build
      sleep 15
    }
    
    health_check() {
      local max_attempts=25
      echo "ğŸ” $SERVER_NAME í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
      for i in $(seq 1 $max_attempts); do
        if curl -sf -m 5 http://localhost:8080/actuator/health | grep -q '"status":"UP"'; then
          echo "âœ… $SERVER_NAME í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
          return 0
        fi
        [ $i -eq $max_attempts ] && return 1
        if [ $((i % 5)) -eq 0 ]; then
          echo "â³ í—¬ìŠ¤ì²´í¬ ì§„í–‰ ì¤‘... ($i/$max_attempts)"
        fi
        sleep 12
      done
    }
    
    cleanup() {
      docker-compose down || true
      docker container prune -f >/dev/null 2>&1 || true
    }
    
    # ë©”ì¸ ë°°í¬ ë¡œì§
    echo "ğŸš€ $SERVER_NAME ë°°í¬ ì‹œì‘..."
    cd /home/ubuntu
    
    # ë°±ì—… ìƒì„±
    if [ -d "lunchchat-app" ]; then
      cd lunchchat-app
      cleanup
    
      if [ -f ".env" ]; then
        CURRENT_TAG=$(grep "^IMAGE_TAG=" ".env" | cut -d'=' -f2)
        if [ -n "$CURRENT_TAG" ]; then
          BACKUP_IMG="$DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:$CURRENT_TAG"
          if ensure_image "$BACKUP_IMG"; then
            echo "BACKUP_IMAGE_TAG=$CURRENT_TAG" > /tmp/backup_info.env
            cp ".env" /tmp/backup.env
            echo "âœ… $SERVER_NAME ë°±ì—… ìƒì„± ì™„ë£Œ: $CURRENT_TAG"
          fi
        fi
      fi
      cd ..
    fi
    
    # ìƒˆ ë²„ì „ ë°°í¬
    rm -rf lunchchat-temp lunchchat-app
    git clone -q --depth 1 --branch "${{ github.ref_name }}" \
      ${{ github.server_url }}/${{ github.repository }}.git lunchchat-temp
    
    mv lunchchat-temp lunchchat-app
    cd lunchchat-app
    
    # ì„¤ì • íŒŒì¼ ì¤€ë¹„
    cp "$ENV_CONFIG_FILE" .env
    cat > firebase-service-account-key.json << 'EOF'
    ${{ secrets.FCM_SERVICE_ACCOUNT_JSON }}
    EOF
    chmod 600 firebase-service-account-key.json
    cat > sheets-key.json << 'EOF'
    ${{ secrets.GOOGLE_SHEETS_SERVICE_ACCOUNT_JSON }}
    EOF
    chmod 600 sheets-key.json
    sed -i "s/^IMAGE_TAG=.*/IMAGE_TAG=$IMAGE_TAG/" .env
    mkdir -p logs
    
    # Database Migration (Server-1ì—ì„œë§Œ)
    if [ "$INCLUDE_DB_MIGRATION" = "true" ]; then
      echo "ğŸ“Š Database Migration ì‹¤í–‰ ì¤‘..."
    fi
    
    # ìƒˆ ì´ë¯¸ì§€ ì¤€ë¹„ ë° ì„œë¹„ìŠ¤ ì‹œì‘
    if [ -z "$IMAGE_TAG" ]; then
      echo "âŒ IMAGE_TAGê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
      exit 1
    fi
    
    NEW_IMG="$DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:$IMAGE_TAG"
    ensure_image "$NEW_IMG" || { echo "âŒ ìƒˆ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"; exit 1; }
    start_services "$IMAGE_TAG"
    
    # í—¬ìŠ¤ì²´í¬ ë° ë¡¤ë°± ì²˜ë¦¬
    if health_check; then
      echo "ğŸ‰ $SERVER_NAME ë°°í¬ ì„±ê³µ!"
      rm -f /tmp/backup*.env
    
      # ì´ë¯¸ì§€ ì •ë¦¬
      docker images "$DOCKER_REGISTRY/$DOCKER_IMAGE_NAME" \
        --format "{{.Repository}}:{{.Tag}} {{.CreatedAt}}" | \
        sort -rk2 | awk '{print $1}' | tail -n +2 | \
        xargs -r docker rmi 2>/dev/null || true
    
    else
      echo "ğŸ”„ $SERVER_NAME ë°°í¬ ì‹¤íŒ¨, ë¡¤ë°± ì‹œë„ ì¤‘..."
    
      if [ -f "/tmp/backup.env" ] && [ -f "/tmp/backup_info.env" ]; then
        cleanup
        source /tmp/backup_info.env
    
        BACKUP_IMG="$DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:$BACKUP_IMAGE_TAG"
        if ensure_image "$BACKUP_IMG"; then
          cp /tmp/backup.env .env
          start_services "$BACKUP_IMAGE_TAG"
    
          if health_check; then
            echo "âœ… $SERVER_NAME ë¡¤ë°± ì„±ê³µ!"
          else
            echo "âŒ $SERVER_NAME ë¡¤ë°± ì‹¤íŒ¨"
          fi
        else
          echo "âŒ $SERVER_NAME ë°±ì—… ì´ë¯¸ì§€ ì‚¬ìš© ë¶ˆê°€"
        fi
      else
        echo "âš ï¸ $SERVER_NAME ë°±ì—… ì—†ìŒ, ìˆ˜ë™ ê°œì… í•„ìš”"
      fi
    
      rm -f /tmp/backup*.env
      exit 1
    fi

  MONITORING_DEPLOY_SCRIPT: |
    set -e
    
    echo "ğŸ¯ ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ ë°°í¬ ì‹œì‘..."
    cd /home/ubuntu
    
    if [ -d "lunchchat-monitoring" ]; then
      cd lunchchat-monitoring/monitoring
      docker-compose down || true
      cd ../..
    fi
    
    rm -rf lunchchat-monitoring-temp lunchchat-monitoring
    git clone -q --depth 1 --branch "${{ github.ref_name }}" \
      ${{ github.server_url }}/${{ github.repository }}.git lunchchat-monitoring-temp
    
    mv lunchchat-monitoring-temp lunchchat-monitoring
    cd lunchchat-monitoring/monitoring
    
    if [ -f "/opt/lunchchat/configs/.env" ]; then
      cp /opt/lunchchat/configs/.env .env
      echo "âœ… ì™¸ë¶€ ëª¨ë‹ˆí„°ë§ ì„¤ì • íŒŒì¼ ì‚¬ìš©"
    else
      echo "âŒ /opt/lunchchat/configs/.env íŒŒì¼ ì—†ìŒ"
      exit 1
    fi
    
    if [ -f "prometheus/prometheus.yml.template" ]; then
      source .env
      envsubst < prometheus/prometheus.yml.template > prometheus/prometheus.yml
      echo "âœ… Prometheus ì„¤ì • íŒŒì¼ ìƒì„± ì™„ë£Œ (APP_SERVER_2_IP: $APP_SERVER_2_IP, APP_SERVER_3_IP: $APP_SERVER_3_IP)"
    fi
    
    docker-compose up -d
    
    sleep 30
    
    if curl -s -m 10 "http://localhost:3000/api/health" > /dev/null && \
       curl -s -m 10 "http://localhost:9090/-/healthy" > /dev/null; then
      echo "ğŸ‰ ëª¨ë‹ˆí„°ë§ ì‹œì‘!"
    else
      echo "âŒ ëª¨ë‹ˆí„°ë§ ë°°í¬ ì‹¤íŒ¨"
      exit 1
    fi

  VERIFY_SCRIPT: |
    echo "ğŸ” $SERVER_NAME ê²€ì¦ ì¤‘..."
    SUCCESS_COUNT=0
    TOTAL_CHECKS=${TOTAL_CHECKS:-5}
    SUCCESS_THRESHOLD=${SUCCESS_THRESHOLD:-80}

    for i in $(seq 1 $TOTAL_CHECKS); do
      response=$(curl -s -o /dev/null -w "%{http_code}" -m 10 "https://$LOAD_BALANCER_IP/actuator/health" || echo "000")
      if [ "$response" = "200" ]; then
        SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
      fi
      sleep 2
    done

    SUCCESS_RATE=$((SUCCESS_COUNT * 100 / TOTAL_CHECKS))
    echo "ğŸ“Š $SERVER_NAME ì„±ê³µë¥ : $SUCCESS_RATE% ($SUCCESS_COUNT/$TOTAL_CHECKS)"

    if [ $SUCCESS_RATE -ge $SUCCESS_THRESHOLD ]; then
      if [ "$SERVER_NAME" = "ì „ì²´ ì‹œìŠ¤í…œ" ]; then
        echo "ğŸ‰ ë¡¤ë§ ë°°í¬ ì™„ë£Œ! ì‹œìŠ¤í…œ ì •ìƒ ì‘ë™ ì¤‘"
      else
        echo "âœ… $SERVER_NAME ê²€ì¦ ì„±ê³µ!"
      fi
    else
      echo "âŒ $SERVER_NAME ê²€ì¦ ì‹¤íŒ¨"
      exit 1
    fi

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/dev/')
    timeout-minutes: 30

    outputs:
      image-tag: ${{ steps.set-tag.outputs.IMAGE_TAG }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build application
        run: ./gradlew build -x test --no-daemon --parallel

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set image tag
        id: set-tag
        run: |
          SAFE_REF_NAME=$(echo "${{ github.ref_name }}" | tr '/\' '-' )
          echo "IMAGE_TAG=${SAFE_REF_NAME}-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64
          tags: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}:${{ steps.set-tag.outputs.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

  deploy-monitoring:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/dev/')
    timeout-minutes: 15

    steps:
      - name: Deploy Monitoring Stack
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.LOAD_BALANCER_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          timeout: 12m
          command_timeout: 10m
          script: |
            export SERVER_NAME="Monitoring-Stack"
            
            source <(cat << 'MONITORING_DEPLOY_SCRIPT'
            ${{ env.MONITORING_DEPLOY_SCRIPT }}
            MONITORING_DEPLOY_SCRIPT
            )

  deploy-server1:
    needs: [ build-and-push, deploy-monitoring ]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/dev/')
    timeout-minutes: 20

    steps:
      - name: Deploy to Server-1
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER1_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          timeout: 15m
          command_timeout: 10m
          envs: DOCKER_REGISTRY,DOCKER_IMAGE_NAME,IMAGE_TAG
          script: |
            export SERVER_NAME="Server-1"
            export INCLUDE_DB_MIGRATION="true"
            export IMAGE_TAG="${{ needs.build-and-push.outputs.image-tag }}"
            export DOCKER_REGISTRY="${{ env.DOCKER_REGISTRY }}"
            export DOCKER_IMAGE_NAME="${{ env.DOCKER_IMAGE_NAME }}"
            export ENV_CONFIG_FILE="/opt/lunchchat/configs/.env.$([[ "${{ github.ref_name }}" == "main" ]] && echo "production" || echo "development")"
            
            source <(cat << 'DEPLOY_SCRIPT'
            ${{ env.DEPLOY_SCRIPT }}
            DEPLOY_SCRIPT
            )

  verify-server1:
    needs: deploy-server1
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Verify Server-1
        run: |
          source <(cat << 'VERIFY_SCRIPT'
          ${{ env.VERIFY_SCRIPT }}
          VERIFY_SCRIPT
          )
        env:
          SERVER_NAME: "Server-1"
          LOAD_BALANCER_IP: ${{ secrets.LOAD_BALANCER_IP }}

  deploy-server2:
    needs: [ build-and-push, verify-server1 ]
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Deploy to Server-2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER2_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          timeout: 15m
          command_timeout: 10m
          envs: DOCKER_REGISTRY,DOCKER_IMAGE_NAME,IMAGE_TAG
          script: |
            export SERVER_NAME="Server-2"
            export INCLUDE_DB_MIGRATION="false"
            export IMAGE_TAG="${{ needs.build-and-push.outputs.image-tag }}"
            export DOCKER_REGISTRY="${{ env.DOCKER_REGISTRY }}"
            export DOCKER_IMAGE_NAME="${{ env.DOCKER_IMAGE_NAME }}"
            export ENV_CONFIG_FILE="/opt/lunchchat/configs/.env.$([[ "${{ github.ref_name }}" == "main" ]] && echo "production" || echo "development")"
            
            source <(cat << 'DEPLOY_SCRIPT'
            ${{ env.DEPLOY_SCRIPT }}
            DEPLOY_SCRIPT
            )

  verify-final:
    needs: deploy-server2
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Final System Verification
        run: |
          source <(cat << 'VERIFY_SCRIPT'
          ${{ env.VERIFY_SCRIPT }}
          VERIFY_SCRIPT
          )
        env:
          SERVER_NAME: "ì „ì²´ ì‹œìŠ¤í…œ"
          LOAD_BALANCER_IP: ${{ secrets.LOAD_BALANCER_IP }}
          TOTAL_CHECKS: "10"
          SUCCESS_THRESHOLD: "80"
