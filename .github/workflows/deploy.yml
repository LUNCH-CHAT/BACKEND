name: LunchChat CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_IMAGE_NAME: lunchchat-backend
  DOCKER_REGISTRY: xoo1228

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 30

    outputs:
      image-tag: ${{ steps.set-tag.outputs.IMAGE_TAG }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build application
        run: ./gradlew build -x test --no-daemon --parallel

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ vars.DOCKERHUB_TOKEN }}

      - name: Set image tag
        id: set-tag
        run: |
          echo "IMAGE_TAG=main-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64
          tags: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}:${{ steps.set-tag.outputs.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

  deploy-production:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 20

    strategy:
      fail-fast: false  # í•œ ì„œë²„ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ì„œë²„ ê³„ì† ì§„í–‰
      matrix:
        server: [
          { id: "server1", name: "Server-1" },
          { id: "server2", name: "Server-2" }
        ]

    steps:
      - name: Set server host
        id: set-host
        run: |
          if [ "${{ matrix.server.id }}" = "server1" ]; then
            echo "host=${{ secrets.SERVER1_HOST }}" >> $GITHUB_OUTPUT
          elif [ "${{ matrix.server.id }}" = "server2" ]; then
            echo "host=${{ secrets.SERVER2_HOST }}" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to ${{ matrix.server.name }}
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ steps.set-host.outputs.host }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          timeout: 15m
          command_timeout: 10m
          script: |
            set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
            
            echo "ğŸš€ ${{ matrix.server.name }} ë°°í¬ ì‹œì‘..."
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì¤€ë¹„
            cd /home/ubuntu
            
            # ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ì§€
            if [ -d "lunchchat-app" ]; then
              cd lunchchat-app
              docker-compose down || true
              cd ..
            fi
            
            # ìµœì‹  ì½”ë“œ í´ë¡  (shallow cloneìœ¼ë¡œ ì†ë„ í–¥ìƒ)
            rm -rf lunchchat-temp
            git clone --depth 1 ${{ github.server_url }}/${{ github.repository }}.git lunchchat-temp
            
            # í™˜ê²½ ë³€ìˆ˜ ë³µì‚¬
            if [ -f "lunchchat-app/.env" ]; then
              cp lunchchat-app/.env lunchchat-temp/
            else
              echo "âš ï¸ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi
            
            # ê¸°ì¡´ í”„ë¡œì íŠ¸ êµì²´
            rm -rf lunchchat-app
            mv lunchchat-temp lunchchat-app
            cd lunchchat-app
            
            # FCM JSON ìƒì„±
            cat > firebase-service-account-key.json << 'FCMEOF'
            ${{ secrets.FCM_SERVICE_ACCOUNT_JSON }}
            FCMEOF
            chmod 600 firebase-service-account-key.json
            
            # GitHub Secrets í™˜ê²½ë³€ìˆ˜ ì¶”ê°€
            cat >> .env << 'ENVEOF'
            
            # GitHub Secretsì—ì„œ ì¶”ê°€ëœ í™˜ê²½ë³€ìˆ˜ë“¤
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            CLIENT_ID=${{ secrets.CLIENT_ID }}
            CLIENT_SECRET=${{ secrets.CLIENT_SECRET }}
            FCM_SERVICE_ACCOUNT_FILE=/app/firebase-service-account-key.json
            IMAGE_TAG=${{ needs.build-and-push.outputs.image-tag }}
            DOCKER_REGISTRY=${{ env.DOCKER_REGISTRY }}
            DOCKER_IMAGE_NAME=${{ env.DOCKER_IMAGE_NAME }}
            SPRING_PROFILES_ACTIVE=dev
            JPA_DDL_AUTO=create-drop
            ENVEOF
            
            # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p logs
            
            echo "ğŸ“¦ Docker ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            
            # Docker ì´ë¯¸ì§€ ë¯¸ë¦¬ ë‹¤ìš´ë¡œë“œ (ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì§„í–‰)
            docker pull ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}:${{ needs.build-and-push.outputs.image-tag }} &
            PULL_PID=$!
            
            # ë‹¤ìš´ë¡œë“œ ì§„í–‰ ìƒí™© ëª¨ë‹ˆí„°ë§
            for i in {1..60}; do
              if kill -0 $PULL_PID 2>/dev/null; then
                echo "ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì§„í–‰ ì¤‘... ($i/60)"
                sleep 5
              else
                wait $PULL_PID
                PULL_EXIT_CODE=$?
                if [ $PULL_EXIT_CODE -eq 0 ]; then
                  echo "âœ… ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!"
                  break
                else
                  echo "âŒ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ (exit code: $PULL_EXIT_CODE)"
                  exit 1
                fi
              fi
            done
            
            # íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬
            if kill -0 $PULL_PID 2>/dev/null; then
              kill $PULL_PID
              echo "âŒ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ íƒ€ì„ì•„ì›ƒ (5ë¶„)"
              exit 1
            fi
            
            echo "ğŸš€ ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘..."
            
            # í™˜ê²½ë³€ìˆ˜ ë‚´ë³´ë‚´ê¸°
            export IMAGE_TAG=${{ needs.build-and-push.outputs.image-tag }}
            export DOCKER_REGISTRY=${{ env.DOCKER_REGISTRY }}
            export DOCKER_IMAGE_NAME=${{ env.DOCKER_IMAGE_NAME }}
            
            # ì»¨í…Œì´ë„ˆ ì‹œì‘ (pull ê±´ë„ˆë›°ê¸°)
            docker-compose up -d backend --no-build
            
            echo "â³ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
            sleep 30
            
            # í—¬ìŠ¤ ì²´í¬ (ì¬ì‹œë„ ë¡œì§ ê°œì„ )
            HEALTH_CHECK_SUCCESS=false
            for i in {1..15}; do
              if curl -f -m 10 http://localhost:8080/actuator/health >/dev/null 2>&1; then
                echo "âœ… ${{ matrix.server.name }} í—¬ìŠ¤ ì²´í¬ ì„±ê³µ!"
                HEALTH_CHECK_SUCCESS=true
                break
              fi
            
              if [ $i -eq 15 ]; then
                echo "âŒ ${{ matrix.server.name }} í—¬ìŠ¤ ì²´í¬ ìµœì¢… ì‹¤íŒ¨"
                echo "=== ì»¨í…Œì´ë„ˆ ìƒíƒœ ==="
                docker ps
                echo "=== ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ ==="
                docker-compose logs --tail 50 backend
                exit 1
              fi
            
              echo "í—¬ìŠ¤ ì²´í¬ ì¬ì‹œë„ ($i/15) - 10ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 10
            done
            
            if [ "$HEALTH_CHECK_SUCCESS" = true ]; then
              # êµ¬ ì´ë¯¸ì§€ ì •ë¦¬
              docker image prune -f
              echo "ğŸ‰ ${{ matrix.server.name }} ë°°í¬ ì™„ë£Œ!"
            fi

  verify-deployment:
    needs: deploy-production
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Verify Load Balancer
        run: |
          echo "ğŸ” ë¡œë“œë°¸ëŸ°ì„œ í™•ì¸ ì¤‘..."
          
          SUCCESS_COUNT=0
          TOTAL_CHECKS=10
          
          for i in $(seq 1 $TOTAL_CHECKS); do
            response=$(curl -s -o /dev/null -w "%{http_code}" -m 10 https://${{ secrets.LOAD_BALANCER_IP }}/actuator/health || echo "000")
            if [ "$response" = "200" ]; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              echo "âœ… ë¡œë“œë°¸ëŸ°ì„œ í—¬ìŠ¤ ì²´í¬ ì„±ê³µ ($i/$TOTAL_CHECKS) - ì„±ê³µë¥ : $SUCCESS_COUNT/$i"
            else
              echo "âš ï¸ ë¡œë“œë°¸ëŸ°ì„œ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨: $response ($i/$TOTAL_CHECKS)"
            fi
            sleep 3
          done
          
          SUCCESS_RATE=$((SUCCESS_COUNT * 100 / TOTAL_CHECKS))
          echo "ğŸ“Š ìµœì¢… ì„±ê³µë¥ : $SUCCESS_RATE% ($SUCCESS_COUNT/$TOTAL_CHECKS)"
          
          if [ $SUCCESS_RATE -ge 80 ]; then
            echo "ğŸ‰ ë°°í¬ ê²€ì¦ ì„±ê³µ! (ì„±ê³µë¥  80% ì´ìƒ)"
          else
            echo "âŒ ë°°í¬ ê²€ì¦ ì‹¤íŒ¨! (ì„±ê³µë¥  80% ë¯¸ë§Œ)"
            exit 1
          fi
