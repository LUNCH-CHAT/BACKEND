name: LunchChat CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_IMAGE_NAME: lunchchat-backend
  DOCKER_REGISTRY: xoo1228

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests
        run: ./gradlew test --no-daemon

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    outputs:
      image-tag: ${{ steps.set-tag.outputs.IMAGE_TAG }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build application
        run: ./gradlew build -x test --no-daemon

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set image tag
        id: set-tag
        run: |
          echo "IMAGE_TAG=main-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}:${{ steps.set-tag.outputs.IMAGE_TAG }}

  deploy-production:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    strategy:
      matrix:
        server: [
          { id: "server1", name: "Server-1" },
          { id: "server2", name: "Server-2" }
        ]

    steps:
      - name: Set server host
        id: set-host
        run: |
          if [ "${{ matrix.server.id }}" = "server1" ]; then
            echo "host=${{ secrets.SERVER1_HOST }}" >> $GITHUB_OUTPUT
          elif [ "${{ matrix.server.id }}" = "server2" ]; then
            echo "host=${{ secrets.SERVER2_HOST }}" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to ${{ matrix.server.name }}
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ steps.set-host.outputs.host }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì¤€ë¹„
            cd /home/ubuntu
            
            # ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ì§€
            if [ -d "lunchchat-app" ]; then
              cd lunchchat-app
              docker-compose down || true
              cd ..
            fi
            
            # ìµœì‹  ì½”ë“œ í´ë¡ 
            rm -rf lunchchat-temp
            git clone ${{ github.server_url }}/${{ github.repository }}.git lunchchat-temp
            
            # í™˜ê²½ ë³€ìˆ˜ ë³µì‚¬ (ê¸°ì¡´ì— ì„¤ì •í•œ .env íŒŒì¼)
            if [ -f "lunchchat/.env" ]; then
              cp lunchchat/.env lunchchat-temp/
            else
              echo "âš ï¸ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•´ì£¼ì„¸ìš”."
              exit 1
            fi
            
            # ê¸°ì¡´ í”„ë¡œì íŠ¸ êµì²´
            rm -rf lunchchat-app
            mv lunchchat-temp lunchchat-app
            
            cd lunchchat-app
            
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            export IMAGE_TAG=${{ needs.build-and-push.outputs.image-tag }}
            export DOCKER_REGISTRY=${{ env.DOCKER_REGISTRY }}
            export DOCKER_IMAGE_NAME=${{ env.DOCKER_IMAGE_NAME }}
            export SPRING_PROFILES_ACTIVE=dev
            
            # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p logs
            
            # ìƒˆ ì´ë¯¸ì§€ í’€ ë° ì‹¤í–‰
            docker-compose pull backend
            docker-compose up -d backend
            
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸°
            echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
            sleep 45
            
            # í—¬ìŠ¤ ì²´í¬
            for i in {1..10}; do
              if curl -f http://localhost:8080/health >/dev/null 2>&1; then
                echo "âœ… ${{ matrix.server.name }} ë°°í¬ ì„±ê³µ!"
                break
              fi
              if [ $i -eq 10 ]; then
                echo "âŒ ${{ matrix.server.name }} í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨"
                docker-compose logs backend
                exit 1
              fi
              echo "í—¬ìŠ¤ ì²´í¬ ì¬ì‹œë„ ($i/10)..."
              sleep 10
            done
            
            # êµ¬ ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f
            
            echo "ğŸ‰ ${{ matrix.server.name }} ë°°í¬ ì™„ë£Œ!"

  verify-deployment:
    needs: deploy-production
    runs-on: ubuntu-latest

    steps:
      - name: Verify Load Balancer
        run: |
          echo "ğŸ” ë¡œë“œë°¸ëŸ°ì„œ í™•ì¸ ì¤‘..."
          
          # ë¡œë“œë°¸ëŸ°ì„œë¥¼ í†µí•œ í—¬ìŠ¤ ì²´í¬
          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.LOAD_BALANCER_IP }}/health || echo "000")
            if [ "$response" = "200" ]; then
              echo "âœ… ë¡œë“œë°¸ëŸ°ì„œ í—¬ìŠ¤ ì²´í¬ ì„±ê³µ ($i/5)"
            else
              echo "âš ï¸ ë¡œë“œë°¸ëŸ°ì„œ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨: $response ($i/5)"
            fi
            sleep 5
          done
          
          echo "ğŸ‰ ì „ì²´ ë°°í¬ ë° ê²€ì¦ ì™„ë£Œ!"